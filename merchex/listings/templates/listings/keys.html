{% extends 'listings/base.html' %}
{% load static %}

{% block title %}Gestion des Cl√©s{% endblock %}

{% block extra_css %}
/* Styles sp√©cifiques √† la page de gestion des cl√©s */
table {     
    width: 100%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid #ddd;
    padding: 8px;
}
th {
    background-color: #f2f2f2;
}
/* Assurez-vous que les boutons sont align√©s sur la m√™me ligne */
.d-flex {
    display: flex;
    gap: 10px; /* Espacement entre les boutons */
}
.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px; /* Largeur fixe pour tous les boutons */
    text-align: center; /* Centrer le texte et l'ic√¥ne */
}
button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 5px 10px; /* Ajouter un peu de padding pour l'espacement */
}
/* Optionnel : Ajustement des ic√¥nes dans les boutons */
button i {
    margin-right: 5px; /* Ajouter un petit espace entre l'ic√¥ne et le texte */
}
.table-responsive thead th {
    position: sticky; /* Rend les en-t√™tes "collants" */
    top: 0; /* Fixe l'en-t√™te tout en haut */
    background-color: #3a9f87; /* Couleur de fond pour le header */
    z-index: 2; /* S'assure que le header passe au-dessus des lignes */
}

/* Style pour les boutons d'export */
.export-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 30px 0;
}

/* === CSS POUR LA VALIDATION === */

/* Animation de secousse pour attirer l'attention sur les champs invalides */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Styles pour les champs valides */
.form-control.is-valid {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.94-.94 1.88 1.88L7.7 5.09l.94.94L5.04 9.63z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Styles pour les champs invalides */
.form-control.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 2.4 2.4m0-2.4L5.8 7'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Styles pour les select valides */
.form-select.is-valid {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e"), url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.94-.94 1.88 1.88L7.7 5.09l.94.94L5.04 9.63z'/%3e%3c/svg%3e");
    background-position: right 0.75rem center, center right 2.25rem;
    background-size: 16px 12px, calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Styles pour les select invalides */
.form-select.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e"), url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6 2.4 2.4m0-2.4L5.8 7'/%3e%3c/svg%3e");
    background-position: right 0.75rem center, center right 2.25rem;
    background-size: 16px 12px, calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

/* Style pour les messages d'erreur */
.invalid-feedback {
    display: block !important;
    font-size: 0.875rem;
    color: #dc3545;
    margin-top: 0.25rem;
    font-weight: 500;
}

.valid-feedback {
    display: block !important;
    font-size: 0.875rem;
    color: #198754;
    margin-top: 0.25rem;
    font-weight: 500;
}

/* Style pour l'alerte de validation */
.validation-alert {
    animation: slideInRight 0.3s ease-out;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-left: 4px solid #dc3545;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Animation de pulsation pour les champs en erreur */
@keyframes pulse-error {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

.form-control.pulse-error {
    animation: pulse-error 1s;
}
{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Affichage des Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- Success message for deletion -->
    {% if delete_success %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            Cl√© supprim√©e avec succ√®s !
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    <h1 class="mb-4">Gestion des cl√©s</h1>
    
    <!-- Bouton Ajouter une Nouvelle Cl√© -->
    <div class="d-flex flex-row bd-highlight mb-3 gap-3">
        <!-- Bouton Ajouter une Nouvelle Cl√© -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addKeyModal">
            <i class="fas fa-plus"></i> Ajouter une Nouvelle Cl√©
        </button>
        
        <!-- Champ de Recherche -->
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Rechercher une cl√©..." class="form-control w-100">
        </div>
        
        <!-- Total des cl√©s align√© √† droite -->
        <div class="mb-3 ms-auto text-end">
            <span class="fw-bold">Total des cl√©s :</span>
            <span>{{ keys_count }}</span>
        </div>
    </div>

    <table class="table table-striped table-hover table-responsive" id="keyTable">
        <thead class="table-dark">
            <tr>
                <th scope="col">N¬∞</th>
                <th scope="col">Noms des cl√©s</th>
                <th scope="col">Emplacements</th>
                <th scope="col">Nombre total de cl√©s</th>
                <th scope="col">Cl√©s attribu√©es</th>
                <th scope="col">Stock armoire</th>
                <th scope="col">Stock coffre</th>
                <th scope="col">Commentaires</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for key_data in keys %}
            <tr {% if not key_data.is_consistent %}class="table-warning"{% endif %}>
                <td>{{ key_data.key_type.number }}</td>
                <td>{{ key_data.key_type.name }}</td>
                <td>{{ key_data.key_type.place }}</td>
                <td>{{ key_data.key_type.total_quantity }}</td>
                <td>{{ key_data.assigned_count }}</td>
                <td>{{ key_data.key_type.in_cabinet }}</td>
                <td>{{ key_data.key_type.in_safe }}</td>
                <td>{{ key_data.key_type.comments }}</td>
                <!-- Actions -->
                <td>
                    <div class="d-flex gap-2">
                        <!-- Bouton Modifier -->
                        <button type="button" class="btn btn-warning btn-sm edit-btn flex-fill action-btn" data-bs-toggle="modal" data-bs-target="#editKeyModal" 
                                data-id="{{ key_data.key_type.id }}"
                                data-number="{{ key_data.key_type.number }}"
                                data-name="{{ key_data.key_type.name }}"
                                data-place="{{ key_data.key_type.place }}"
                                data-total-quantity="{{ key_data.key_type.total_quantity }}"
                                data-in-cabinet="{{ key_data.key_type.in_cabinet }}"
                                data-in-safe="{{ key_data.key_type.in_safe }}"
                                data-comments="{{ key_data.key_type.comments }}"
                                style="width: 80px;">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                
                        <!-- Bouton Retirer -->
                        <form method="post" action="{% url 'key_delete' key_data.key_type.id %}" style="width: 80px;">
                            {% csrf_token %}
                            <button type="button" class="btn btn-danger btn-sm" 
                                    data-bs-toggle="modal" data-bs-target="#deleteKeyModal" 
                                    data-delete-url="{% url 'key_delete' key_data.key_type.id %}" 
                                    data-key-number="{{ key_data.key_type.number }}">
                                <i class="fas fa-trash"></i> Retirer
                            </button>
                        </form>
                        
                        <!-- Bouton Attributions avec popover et badge de d√©tenteurs -->
                        <button type="button" class="btn btn-info btn-sm action-btn" 
                                data-bs-toggle="popover" 
                                data-bs-trigger="focus"
                                data-bs-html="true"
                                data-bs-title="Attributions pour cl√© n¬∞{{ key_data.key_type.number }}"
                                data-bs-content="{% if key_data.assigned_count > 0 %}
                                                    <p><strong>{{ key_data.assigned_count }} exemplaire(s) attribu√©(s)</strong></p>
                                                    <hr class='my-2'>
                                                    <ul class='list-unstyled mb-0'>
                                                        {% for holder in key_data.key_holders %}
                                                            <li><strong>{{ holder.name }}</strong> (depuis le {{ holder.assignment_date }})</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    Aucune attribution
                                                {% endif %}">
                            <i class="fas fa-key"></i> 
                            <span class="badge bg-secondary">{{ key_data.assigned_count }}</span>
                        </button>
                        
                        {% if not key_data.is_consistent %}
                        <span class="badge bg-warning text-dark" title="{{ key_data.consistency_message }}">
                            <i class="fas fa-exclamation-triangle"></i> Incoh√©rence
                        </span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Boutons d'export ajout√©s ici -->
    <div class="export-buttons">
        <button type="button" class="btn btn-danger" id="generatePdfBtn">
            <i class="fas fa-file-pdf"></i> G√©n√©rer PDF
        </button>
        <button type="button" class="btn btn-success" id="generateXlsxBtn">
            <i class="fas fa-file-excel"></i> G√©n√©rer XLSX
        </button>
    </div>
</div>

<!-- Modal for adding a new key -->
<div class="modal fade" id="addKeyModal" tabindex="-1" aria-labelledby="addKeyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'key_create' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="addKeyModalLabel">Ajouter une Nouvelle Cl√©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Champ Num√©ro de cl√© (select) -->
                    <div class="mb-3">
                        <label for="id_number" class="form-label fw-bold">Num√©ro de cl√© *</label>
                        <select name="number" id="id_number" class="form-select" required>
                            <option value="" selected disabled>Choisissez un num√©ro disponible</option>
                            {% for number in available_numbers %}
                                <option value="{{ number }}">{{ number }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="id_name" class="form-label fw-bold">Nom de la cl√© *</label>
                        <input type="text" name="name" id="id_name" class="form-control" placeholder="Entrez le nom de la cl√©" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_place" class="form-label fw-bold">Emplacement *</label>
                        <input type="text" name="place" id="id_place" class="form-control" placeholder="Emplacement de la cl√©" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_total_quantity" class="form-label fw-bold">Nombre total d'exemplaire *</label>
                        <input type="number" name="total_quantity" id="id_total_quantity" class="form-control" placeholder="Nombre total d'exemplaires √† disposition" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_in_cabinet" class="form-label fw-bold">Stock armoire *</label>
                        <input type="number" name="in_cabinet" id="id_in_cabinet" class="form-control" placeholder="Nombre de cl√©s stock√© dans l'armoire" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_in_safe" class="form-label fw-bold">Stock coffre *</label>
                        <input type="number" name="in_safe" id="id_in_safe" class="form-control" placeholder="Nombre de cl√© stock√© dans le coffre" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_comments" class="form-label fw-bold">Commentaires</label>
                        <textarea name="comments" id="id_comments" class="form-control" rows="3" placeholder="Ajoutez des commentaires..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Ajouter la cl√©
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal for Editing a Key -->
<div class="modal fade" id="editKeyModal" tabindex="-1" aria-labelledby="editKeyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'key_update' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="editKeyModalLabel">Modification des informations de la Cl√©</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <!-- Hidden fields to store original values -->
                    <input type="hidden" name="key_id" id="editKeyId">
                    <input type="hidden" name="original_total_quantity" id="original_total_quantity">
                    <input type="hidden" name="original_in_cabinet" id="original_in_cabinet">
                    
                    <!-- Styled Form Fields for Editing -->
                    <div class="mb-3 d-flex align-items-center">
                        <!-- Champ Num√©ro de la cl√© -->
                        <div style="width: 100px;">
                            <label for="edit_id_number" class="form-label fw-bold">N¬∞ *</label>
                            <input type="number" name="number" id="edit_id_number" class="form-control" placeholder="000" readonly required>
                        </div>
                        <!-- Champ Nom de la cl√© -->
                        <div class="flex-grow-1 me-3">
                            <label for="edit_id_name" class="form-label fw-bold">Nom de la cl√© *</label>
                            <input type="text" name="name" id="edit_id_name" class="form-control" placeholder="Entrez le nom de la cl√©" required>
                        </div>                        
                    </div>
                    <div class="mb-3">
                        <label for="edit_id_place" class="form-label fw-bold">Emplacement *</label>
                        <input type="text" name="place" id="edit_id_place" class="form-control" placeholder="Emplacement de la cl√©" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_id_total_quantity" class="form-label fw-bold">Nombre total d'exemplaires *</label>
                        <input type="number" name="total_quantity" id="edit_id_total_quantity" class="form-control" placeholder="Nombre total d'exemplaires" min="0" required>
                        <small class="form-text text-muted">Augmenter ce nombre ajoutera automatiquement des cl√©s dans l'armoire.</small>
                    </div>
                    <div class="mb-3">
                        <label for="edit_id_in_cabinet" class="form-label fw-bold">Stock armoire *</label>
                        <input type="number" name="in_cabinet" id="edit_id_in_cabinet" class="form-control" placeholder="Nombre de cl√©s stock√© dans l'armoire" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_id_in_safe" class="form-label fw-bold">Stock coffre *</label>
                        <input type="number" name="in_safe" id="edit_id_in_safe" class="form-control" placeholder="Nombre de cl√© stock√© dans le coffre" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_id_comments" class="form-label fw-bold">Commentaires</label>
                        <textarea name="comments" id="edit_id_comments" class="form-control" rows="3" placeholder="Ajoutez des commentaires..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Enregistrer les Modifications
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteKeyModal" tabindex="-1" aria-labelledby="deleteKeyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteKeyModalLabel">Retirer la cl√©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Voulez-vous vraiment supprimer la cl√© num√©ro <strong id="keyNumberToDelete"></strong> et tous ses exemplaires ? Cette action ne peut pas √™tre annul√©e. Cependant le num√©ro de cl√© sera de nouveau disponible pour une nouvelle cl√©.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form id="deleteKeyForm" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Scripts pour la g√©n√©ration de PDF et XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>

<!-- === SCRIPT DE VALIDATION DES FORMULAIRES === -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('üîß Initialisation de la validation des formulaires...');
    
    // ========== FONCTIONS UTILITAIRES ==========
    
    // Fonction pour valider un champ individuel
    function validateField(field, fieldName) {
        const value = field.value.trim();
        const isValid = value !== '' && value !== null;
        
        // Supprimer les classes existantes
        field.classList.remove('is-valid', 'is-invalid', 'pulse-error');
        
        // Supprimer le message d'erreur existant
        const existingError = field.parentNode.querySelector('.invalid-feedback');
        if (existingError) {
            existingError.remove();
        }
        
        if (!isValid) {
            // Ajouter la classe d'erreur
            field.classList.add('is-invalid');
            
            // Cr√©er et ajouter le message d'erreur
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>Le champ "${fieldName}" est obligatoire.`;
            field.parentNode.appendChild(errorDiv);
            
            // Animation de secousse et pulsation
            field.style.animation = 'shake 0.5s';
            setTimeout(() => {
                field.style.animation = '';
                field.classList.add('pulse-error');
            }, 500);
            
            return false;
        } else {
            // Ajouter la classe de succ√®s
            field.classList.add('is-valid');
            
            // Ajouter un message de succ√®s (optionnel)
            const successDiv = document.createElement('div');
            successDiv.className = 'valid-feedback';
            successDiv.innerHTML = `<i class="fas fa-check-circle me-1"></i>Champ valide`;
            field.parentNode.appendChild(successDiv);
            
            return true;
        }
    }
    
    // Fonction pour valider un champ num√©rique
    function validateNumericField(field, fieldName) {
        const value = field.value.trim();
        const numValue = parseInt(value);
        
        // Supprimer les classes existantes
        field.classList.remove('is-valid', 'is-invalid', 'pulse-error');
        
        // Supprimer les messages existants
        const existingError = field.parentNode.querySelector('.invalid-feedback');
        const existingSuccess = field.parentNode.querySelector('.valid-feedback');
        if (existingError) existingError.remove();
        if (existingSuccess) existingSuccess.remove();
        
        // V√©rifier si le champ est vide
        if (value === '') {
            field.classList.add('is-invalid');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>Le champ "${fieldName}" est obligatoire.`;
            field.parentNode.appendChild(errorDiv);
            return false;
        }
        
        // V√©rifier si c'est un nombre valide et positif
        if (isNaN(numValue) || numValue < 0) {
            field.classList.add('is-invalid');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>Veuillez entrer un nombre valide (‚â• 0).`;
            field.parentNode.appendChild(errorDiv);
            return false;
        }
        
        // Champ valide
        field.classList.add('is-valid');
        const successDiv = document.createElement('div');
        successDiv.className = 'valid-feedback';
        successDiv.innerHTML = `<i class="fas fa-check-circle me-1"></i>Valeur valide`;
        field.parentNode.appendChild(successDiv);
        return true;
    }
    
    // Fonction pour valider tous les champs obligatoires d'un formulaire
    function validateForm(form, requiredFields) {
        let isFormValid = true;
        let firstInvalidField = null;
        
        console.log('üîç Validation du formulaire...');
        
        requiredFields.forEach(({ selector, name, type }) => {
            const field = form.querySelector(selector);
            if (field) {
                let isFieldValid;
                
                if (type === 'numeric') {
                    isFieldValid = validateNumericField(field, name);
                } else {
                    isFieldValid = validateField(field, name);
                }
                
                if (!isFieldValid) {
                    isFormValid = false;
                    if (!firstInvalidField) {
                        firstInvalidField = field;
                    }
                    console.log(`‚ùå Champ invalide: ${name}`);
                } else {
                    console.log(`‚úÖ Champ valide: ${name}`);
                }
            }
        });
        
        // Faire d√©filer vers le premier champ invalide et le focuser
        if (firstInvalidField) {
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => {
                firstInvalidField.focus();
                firstInvalidField.select();
            }, 300);
        }
        
        return isFormValid;
    }
    
    // Fonction pour afficher une alerte de validation
    function showValidationAlert(message, type = 'danger') {
        // Supprimer l'alerte existante
        const existingAlert = document.querySelector('.validation-alert');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        // Cr√©er la nouvelle alerte
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show validation-alert`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.maxWidth = '400px';
        
        const icon = type === 'danger' ? 'exclamation-triangle' : 'check-circle';
        
        alertDiv.innerHTML = `
            <i class="fas fa-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-supprimer apr√®s 5 secondes
        setTimeout(() => {
            if (alertDiv && alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // ========== CONFIGURATION DES CHAMPS OBLIGATOIRES ==========
    
    // Champs obligatoires pour le formulaire d'ajout
    const addFormRequiredFields = [
        { selector: '#id_number', name: 'Num√©ro de cl√©', type: 'text' },
        { selector: '#id_name', name: 'Nom de la cl√©', type: 'text' },
        { selector: '#id_place', name: 'Emplacement', type: 'text' },
        { selector: '#id_total_quantity', name: 'Nombre total d\'exemplaires', type: 'numeric' },
        { selector: '#id_in_cabinet', name: 'Stock armoire', type: 'numeric' },
        { selector: '#id_in_safe', name: 'Stock coffre', type: 'numeric' }
    ];
    
    // Champs obligatoires pour le formulaire de modification
    const editFormRequiredFields = [
        { selector: '#edit_id_number', name: 'Num√©ro de cl√©', type: 'text' },
        { selector: '#edit_id_name', name: 'Nom de la cl√©', type: 'text' },
        { selector: '#edit_id_place', name: 'Emplacement', type: 'text' },
        { selector: '#edit_id_total_quantity', name: 'Nombre total d\'exemplaires', type: 'numeric' },
        { selector: '#edit_id_in_cabinet', name: 'Stock armoire', type: 'numeric' },
        { selector: '#edit_id_in_safe', name: 'Stock coffre', type: 'numeric' }
    ];
    
    // ========== VALIDATION EN TEMPS R√âEL ==========
    
    function setupRealTimeValidation(requiredFields) {
        requiredFields.forEach(({ selector, name, type }) => {
            const field = document.querySelector(selector);
            if (field) {
                console.log(`üîó Configuration validation temps r√©el pour: ${selector}`);
                
                // Validation √† la perte de focus
                field.addEventListener('blur', function() {
                    if (this.value.trim() !== '') {
                        if (type === 'numeric') {
                            validateNumericField(this, name);
                        } else {
                            validateField(this, name);
                        }
                    }
                });
                
                // Supprimer les erreurs d√®s que l'utilisateur commence √† taper
                field.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid') && this.value.trim() !== '') {
                        this.classList.remove('is-invalid', 'pulse-error');
                        const errorMsg = this.parentNode.querySelector('.invalid-feedback');
                        if (errorMsg) {
                            errorMsg.remove();
                        }
                        
                        // Revalider en temps r√©el pour les champs num√©riques
                        if (type === 'numeric') {
                            const numValue = parseInt(this.value);
                            if (!isNaN(numValue) && numValue >= 0) {
                                this.classList.add('is-valid');
                                const successDiv = document.createElement('div');
                                successDiv.className = 'valid-feedback';
                                successDiv.innerHTML = `<i class="fas fa-check-circle me-1"></i>Valeur valide`;
                                this.parentNode.appendChild(successDiv);
                            }
                        } else {
                            this.classList.add('is-valid');
                            const successDiv = document.createElement('div');
                            successDiv.className = 'valid-feedback';
                            successDiv.innerHTML = `<i class="fas fa-check-circle me-1"></i>Champ valide`;
                            this.parentNode.appendChild(successDiv);
                        }
                    }
                });
                
                // Validation sp√©ciale pour les champs num√©riques
                if (type === 'numeric') {
                    field.addEventListener('input', function() {
                        // Emp√™cher la saisie de caract√®res non num√©riques
                        this.value = this.value.replace(/[^0-9]/g, '');
                    });
                }
            }
        });
    }
    
    // Configurer la validation en temps r√©el
    setupRealTimeValidation([...addFormRequiredFields, ...editFormRequiredFields]);
    
    // ========== VALIDATION DU FORMULAIRE D'AJOUT ==========
    
    const addKeyForm = document.querySelector('#addKeyModal form');
    if (addKeyForm) {
        console.log('üìù Configuration validation formulaire d\'ajout');
        
        addKeyForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Emp√™cher la soumission par d√©faut
            
            console.log('üîç Validation formulaire d\'ajout d√©clench√©e...');
            
            const isValid = validateForm(this, addFormRequiredFields);
            
            if (isValid) {
                console.log('‚úÖ Formulaire d\'ajout valide - Soumission autoris√©e');
                
                // Afficher feedback de chargement
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ajout en cours...';
                submitBtn.disabled = true;
                
                // Afficher alerte de succ√®s
                showValidationAlert('Formulaire valide. Ajout de la cl√© en cours...', 'success');
                
                // Soumettre le formulaire
                setTimeout(() => {
                    this.submit();
                }, 500);
            } else {
                console.log('‚ùå Formulaire d\'ajout invalide');
                showValidationAlert('Veuillez corriger les erreurs avant de continuer.');
            }
        });
    }
    
    // ========== VALIDATION DU FORMULAIRE DE MODIFICATION ==========
    
    const editKeyForm = document.querySelector('#editKeyModal form');
    if (editKeyForm) {
        console.log('üìù Configuration validation formulaire de modification');
        
        editKeyForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Emp√™cher la soumission par d√©faut
            
            console.log('üîç Validation formulaire de modification d√©clench√©e...');
            
            const isValid = validateForm(this, editFormRequiredFields);
            
            if (isValid) {
                console.log('‚úÖ Formulaire de modification valide');
                
                // Demander confirmation
                const confirmation = confirm("√ätes-vous s√ªr de vouloir modifier cette cl√© ?");
                if (confirmation) {
                    console.log('‚úÖ Confirmation re√ßue - Soumission autoris√©e');
                    
                    // Afficher feedback de chargement
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Modification en cours...';
                    submitBtn.disabled = true;
                    
                    // Afficher alerte de succ√®s
                    showValidationAlert('Formulaire valide. Modification en cours...', 'success');
                    
                    // Soumettre le formulaire
                    setTimeout(() => {
                        this.submit();
                    }, 500);
                } else {
                    console.log('‚ùå Confirmation annul√©e par l\'utilisateur');
                }
            } else {
                console.log('‚ùå Formulaire de modification invalide');
                showValidationAlert('Veuillez corriger les erreurs avant de continuer.');
            }
        });
    }
    
    // ========== R√âINITIALISATION DES FORMULAIRES ==========
    
    // Fonction pour r√©initialiser la validation d'un formulaire
    function resetFormValidation(form) {
        if (form) {
            // Supprimer toutes les classes de validation
            const fields = form.querySelectorAll('.form-control, .form-select');
            fields.forEach(field => {
                field.classList.remove('is-valid', 'is-invalid', 'pulse-error');
            });
            
            // Supprimer tous les messages de feedback
            const feedbacks = form.querySelectorAll('.invalid-feedback, .valid-feedback');
            feedbacks.forEach(feedback => feedback.remove());
            
            // R√©activer le bouton de soumission
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                const originalIcon = submitBtn.innerHTML.includes('Ajouter') ? 'save' : 'save';
                const originalText = submitBtn.innerHTML.includes('Ajouter') ? 'Ajouter la cl√©' : 'Enregistrer les Modifications';
                submitBtn.innerHTML = `<i class="fas fa-${originalIcon} me-2"></i>${originalText}`;
            }
        }
    }
    
    // R√©initialiser la validation quand les modals s'ouvrent
    const addModal = document.getElementById('addKeyModal');
    const editModal = document.getElementById('editKeyModal');
    
    if (addModal) {
        addModal.addEventListener('show.bs.modal', function() {
            console.log('üîÑ R√©initialisation formulaire d\'ajout');
            const form = this.querySelector('form');
            resetFormValidation(form);
        });
    }
    
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function() {
            console.log('üîÑ R√©initialisation formulaire de modification');
            const form = this.querySelector('form');
            resetFormValidation(form);
        });
    }
    
    console.log('‚úÖ Validation des formulaires initialis√©e avec succ√®s!');
});
</script>

<!-- VOS SCRIPTS EXISTANTS CONTINUENT ICI -->
<script>
// Add event listener to delete buttons
document.addEventListener('DOMContentLoaded', function () {
    var deleteButtons = document.querySelectorAll('[data-bs-target="#deleteKeyModal"]');
    deleteButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            // Get the key number and delete URL from the clicked button
            var keyNumber = this.getAttribute('data-key-number');
            var deleteUrl = this.getAttribute('data-delete-url');
            // Update the modal content with the key number
            document.getElementById('keyNumberToDelete').innerText = keyNumber;
            // Set the action of the delete form to the delete URL
            document.getElementById('deleteKeyForm').setAttribute('action', deleteUrl);
        });
    });
    
    // Ajout des gestionnaires pour les boutons d'export
    document.getElementById('generatePdfBtn').addEventListener('click', function() {
        // G√©n√©rer le PDF avec jsPDF
        generatePDF();
    });
    
    document.getElementById('generateXlsxBtn').addEventListener('click', function() {
        // G√©n√©rer le fichier XLSX avec SheetJS
        generateXLSX();
    });
    
    // Fonction pour g√©n√©rer le PDF
    function generatePDF() {
        // Cr√©er un nouveau document PDF
        const doc = new jsPDF();
        
        // Titre du document
        doc.setFontSize(18);
        doc.text("Liste des cl√©s", 14, 20);
        
        // Informations du document
        const date = new Date().toLocaleDateString('fr-FR');
        doc.setFontSize(11);
        doc.text(`G√©n√©r√© le: ${date}`, 14, 30);
        doc.text(`Total des cl√©s: ${document.querySelector('.ms-auto span:last-child').textContent}`, 14, 35);
        
        // Cr√©ation du tableau
        const tableData = [];
        const table = document.getElementById('keyTable');
        const rows = table.querySelectorAll('tbody tr');
        
        // Parcourir toutes les lignes du tableau visible
        rows.forEach((row) => {
            if (row.style.display !== 'none') {
                const number = row.cells[0].textContent.trim();
                const name = row.cells[1].textContent.trim();
                const place = row.cells[2].textContent.trim();
                const totalQuantity = row.cells[3].textContent.trim();
                const assignedCount = row.cells[4].textContent.trim();
                const inCabinet = row.cells[5].textContent.trim();
                const inSafe = row.cells[6].textContent.trim();
                tableData.push([number, name, place, totalQuantity, assignedCount, inCabinet, inSafe]);
            }
        });
        
        // Ajouter le tableau au PDF
        doc.autoTable({
            head: [['N¬∞', 'Nom de la cl√©', 'Emplacement', 'Nb. exemplaires', 'Attribu√©s', 'En armoire', 'En coffre']],
            body: tableData,
            startY: 40,
            styles: { fontSize: 8, cellPadding: 2 },
            headStyles: { fillColor: [58, 159, 135] },
            margin: { top: 40 },
            columnStyles: {
                0: { cellWidth: 15 }, // N¬∞
                1: { cellWidth: 40 }, // Nom
                2: { cellWidth: 30 }, // Emplacement
                3: { cellWidth: 20 }, // Nb exemplaires
                4: { cellWidth: 20 }, // Attribu√©s
                5: { cellWidth: 20 }, // En armoire
                6: { cellWidth: 20 }  // En coffre
            }
        });
        
        // Ajouter le footer
        doc.setFontSize(10);
        doc.text("¬© √âglise √âvang√©lique Rencontre Esp√©rance", 14, doc.internal.pageSize.height - 10);
        
        // Enregistrer le PDF
        doc.save("liste_cles.pdf");
    }
    
    // Fonction pour g√©n√©rer le fichier XLSX
    function generateXLSX() {
        // Cr√©er un nouveau workbook
        const wb = XLSX.utils.book_new();
        
        // Pr√©parer les donn√©es
        const tableData = [];
        const table = document.getElementById('keyTable');
        const rows = table.querySelectorAll('tbody tr');
        
        // Parcourir toutes les lignes du tableau visible
        rows.forEach((row) => {
            if (row.style.display !== 'none') {
                const number = row.cells[0].textContent.trim();
                const name = row.cells[1].textContent.trim();
                const place = row.cells[2].textContent.trim();
                const totalQuantity = row.cells[3].textContent.trim();
                const assignedCount = row.cells[4].textContent.trim();
                const inCabinet = row.cells[5].textContent.trim();
                const inSafe = row.cells[6].textContent.trim();
                const comments = row.cells[7].textContent.trim();
                
                tableData.push({
                    "N¬∞": number,
                    "Nom de la cl√©": name,
                    "Emplacement": place,
                    "Nombre d'exemplaires": totalQuantity,
                    "Exemplaires attribu√©s": assignedCount,
                    "En armoire": inCabinet,
                    "En coffre": inSafe,
                    "Commentaires": comments
                });
            }
        });
        
        // Cr√©er une feuille de calcul √† partir des donn√©es
        const ws = XLSX.utils.json_to_sheet(tableData);
        
        // Ajouter la feuille au workbook
        XLSX.utils.book_append_sheet(wb, ws, "Cl√©s");
        
        // G√©n√©rer le fichier XLSX et le t√©l√©charger
        XLSX.writeFile(wb, "liste_cles.xlsx");
    }
});
</script>

<!-- JavaScript to Populate Edit Modal -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Get all edit buttons
    var editButtons = document.querySelectorAll('.edit-btn');
    
    // Loop through buttons and add click event listener
    editButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            // Get key data from the button's data attributes
            var keyId = this.getAttribute('data-id');
            var keyNumber = this.getAttribute('data-number');
            var keyName = this.getAttribute('data-name');
            var keyPlace = this.getAttribute('data-place');
            var keyTotal = this.getAttribute('data-total-quantity');
            var keyInCabinet = this.getAttribute('data-in-cabinet');
            var keyInSafe = this.getAttribute('data-in-safe');
            var keyComments = this.getAttribute('data-comments');
            
            // Populate the modal fields
            document.getElementById('editKeyId').value = keyId;
            document.getElementById('edit_id_number').value = keyNumber;
            document.getElementById('edit_id_name').value = keyName;
            document.getElementById('edit_id_place').value = keyPlace;
            document.getElementById('edit_id_total_quantity').value = keyTotal;
            document.getElementById('original_total_quantity').value = keyTotal; // Stocker la valeur originale
            document.getElementById('original_in_cabinet').value = keyInCabinet; // Stocker la valeur originale du stock armoire
            document.getElementById('edit_id_in_cabinet').value = keyInCabinet;
            document.getElementById('edit_id_in_safe').value = keyInSafe;
            document.getElementById('edit_id_comments').value = keyComments;
        });
    });
    
    // Add event listener for total quantity changes
    const totalQuantityInput = document.getElementById('edit_id_total_quantity');
    const inCabinetInput = document.getElementById('edit_id_in_cabinet');
    
    if (totalQuantityInput && inCabinetInput) {
        totalQuantityInput.addEventListener('input', function() {
            // Get original values
            const originalTotal = parseInt(document.getElementById('original_total_quantity').value) || 0;
            const originalCabinet = parseInt(document.getElementById('original_in_cabinet').value) || 0;
            const newTotal = parseInt(this.value) || 0;
            
            // Calculate the difference from original
            const difference = newTotal - originalTotal;
            
            // If total has increased from original, add the difference to the original cabinet value
            if (difference > 0) {
                inCabinetInput.value = originalCabinet + difference;
                
                // Visual feedback (optional)
                inCabinetInput.classList.add('is-valid');
                setTimeout(() => {
                    inCabinetInput.classList.remove('is-valid');
                }, 1000);
            } else {
                // If total is less than or equal to original, reset to original cabinet value
                inCabinetInput.value = originalCabinet;
            }
        });
    }
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Initialisation des popovers
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
    [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, {
        html: true,
        trigger: 'focus',
        container: 'body'
    }));
    
    console.log('Nombre de popovers initialis√©s:', popoverTriggerList.length);
});
</script>

<!-- Script de recherche dans le tableau -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Gestion de la recherche
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keyup', function () {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('#keyTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }
});
</script>
{% endblock %}