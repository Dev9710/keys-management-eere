{% extends 'listings/base.html' %}
{% load static %}

{% block title %}Gestion des Clés{% endblock %}

{% block extra_css %}
/* Styles spécifiques à la page de gestion des clés */
table {     
    width: 100%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid #ddd;
    padding: 8px;
}
th {
    background-color: #f2f2f2;
}
/* Assurez-vous que les boutons sont alignés sur la même ligne */
.d-flex {
    display: flex;
    gap: 10px; /* Espacement entre les boutons */
}
.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px; /* Largeur fixe pour tous les boutons */
    text-align: center; /* Centrer le texte et l'icône */
}
button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 5px 10px; /* Ajouter un peu de padding pour l'espacement */
}
/* Optionnel : Ajustement des icônes dans les boutons */
button i {
    margin-right: 5px; /* Ajouter un petit espace entre l'icône et le texte */
}
.table-responsive thead th {
    position: sticky; /* Rend les en-têtes "collants" */
    top: 0; /* Fixe l'en-tête tout en haut */
    background-color: #3a9f87; /* Couleur de fond pour le header */
    z-index: 2; /* S'assure que le header passe au-dessus des lignes */
}

/* Style pour les boutons d'export */
.export-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 30px 0;
}
{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Affichage des Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
            </div>
        {% endfor %}
    {% endif %}
    <!-- Success message for deletion -->
      {% if delete_success %}
      <div class="alert alert-{{ message.tags }}  alert-dismissible fade show" role="alert">
          Clé supprimée avec succès !
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
  {% endif %}
<h1 class="mb-4">Gestion des clés</h1>
<!-- Bouton Ajouter une Nouvelle Clé -->
<div class="d-flex flex-row bd-highlight mb-3 gap-3">
    <!-- Bouton Ajouter une Nouvelle Clé -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addKeyModal">
        <i class="fas fa-plus"></i> Ajouter une Nouvelle Clé
    </button>
    
    <!-- Champ de Recherche -->
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Rechercher une clé..." class="form-control w-100">
    </div>
    
    <!-- Total des clés aligné à droite -->
    <div class="mb-3 ms-auto text-end">
        <span class="fw-bold">Total des clés :</span>
        <span>{{ keys_count }}</span>
    </div>
</div>

<table class="table table-striped table-hover table-responsive" id="keyTable">
    <thead class="table-dark">
        <tr>
            <th scope="col">N°</th>
            <th scope="col">Noms des clés</th>
            <th scope="col">Emplacements</th>
            <th scope="col">Nombre total de clés</th>
            <th scope="col">Clés attribuées</th>
            <!-- Supprimez cette ligne:
            <th scope="col">Exemplaires disponibles</th> -->
            <th scope="col">Stock armoire</th>
            <th scope="col">Stock coffre</th>
            <th scope="col">Commentaires</th>
            <th scope="col">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for key_data in keys %}
        <tr {% if not key_data.is_consistent %}class="table-warning"{% endif %}>
            <td>{{ key_data.key_type.number }}</td>
            <td>{{ key_data.key_type.name }}</td>
            <td>{{ key_data.key_type.place }}</td>
            <td>{{ key_data.key_type.total_quantity }}</td>
            <td>{{ key_data.assigned_count }}</td>
            <!-- Supprimez cette ligne:
            <td>{{ key_data.available_count }}</td> -->
            <td>{{ key_data.key_type.in_cabinet }}</td>
            <td>{{ key_data.key_type.in_safe }}</td>
            <td>{{ key_data.key_type.comments }}</td>
            <!-- Actions -->
            <td>
                <div class="d-flex gap-2">
                    <!-- Bouton Modifier -->
                    <button type="button" class="btn btn-warning btn-sm edit-btn flex-fill action-btn" data-bs-toggle="modal" data-bs-target="#editKeyModal" 
                            data-id="{{ key_data.key_type.id }}"
                            data-number="{{ key_data.key_type.number }}"
                            data-name="{{ key_data.key_type.name }}"
                            data-place="{{ key_data.key_type.place }}"
                            data-total-quantity="{{ key_data.key_type.total_quantity }}"
                            data-in-cabinet="{{ key_data.key_type.in_cabinet }}"
                            data-in-safe="{{ key_data.key_type.in_safe }}"
                            data-comments="{{ key_data.key_type.comments }}"
                            style="width: 80px;">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
            
                    <!-- Bouton Retirer -->
                    <form method="post" action="{% url 'key_delete' key_data.key_type.id %}" style="width: 80px;">
                        {% csrf_token %}
                        <button type="button" class="btn btn-danger btn-sm" 
                                data-bs-toggle="modal" data-bs-target="#deleteKeyModal" 
                                data-delete-url="{% url 'key_delete' key_data.key_type.id %}" 
                                data-key-number="{{ key_data.key_type.number }}">
                            <i class="fas fa-trash"></i> Retirer
                        </button>
                    </form>
            
                    <!-- Bouton Attributions avec popover et badge de détenteurs -->
                    <button type="button" class="btn btn-info btn-sm action-btn" 
                            data-bs-toggle="popover" 
                            title="Attributions" 
                            tabindex="0"
                            data-bs-content="{% if key_data.assigned_count > 0 %}{{ key_data.assigned_count }} exemplaire(s) attribué(s){% else %}Aucune attribution{% endif %}">
                        <i class="fas fa-key"></i> 
                        <span class="badge bg-secondary">{{ key_data.assigned_count }}</span>
                    </button>
                    
                    {% if not key_data.is_consistent %}
                    <span class="badge bg-warning text-dark" title="{{ key_data.consistency_message }}">
                        <i class="fas fa-exclamation-triangle"></i> Incohérence
                    </span>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<!-- Boutons d'export ajoutés ici -->
<div class="export-buttons">
    <button type="button" class="btn btn-danger" id="generatePdfBtn">
        <i class="fas fa-file-pdf"></i> Générer PDF
    </button>
    <button type="button" class="btn btn-success" id="generateXlsxBtn">
        <i class="fas fa-file-excel"></i> Générer XLSX
    </button>
</div>
</div>
<!-- Modal for adding a new key -->
<div class="modal fade" id="addKeyModal" tabindex="-1" aria-labelledby="addKeyModalLabel" aria-hidden="true">
<div class="modal-dialog">
    <div class="modal-content">
        <form method="post" action="{% url 'key_create' %}">
            {% csrf_token %}
            <div class="modal-header">
                <h5 class="modal-title" id="addKeyModalLabel">Ajouter une Nouvelle Clé</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Champ Numéro de clé (select) -->
                <div class="mb-3">
                    <label for="id_number" class="form-label fw-bold">Numéro de clé</label>
                    <select name="number" id="id_number" class="form-select">
                        <option value="" selected disabled>Choisissez un numéro disponible</option>
                        {% for number in available_numbers %}
                            <option value="{{ number }}">{{ number }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="id_name" class="form-label fw-bold">Nom de la clé</label>
                    <input type="text" name="name" id="id_name" class="form-control" placeholder="Entrez le nom de la clé">
                </div>
                <div class="mb-3">
                    <label for="id_place" class="form-label fw-bold">Emplacement</label>
                    <input type="text" name="place" id="id_place" class="form-control" placeholder="Emplacement de la clé">
                </div>
                <div class="mb-3">
                    <label for="id_total_quantity" class="form-label fw-bold">Nombre total d'exemplaire</label>
                    <input type="number" name="total_quantity" id="id_total_quantity" class="form-control" placeholder="Nombre total d'exemplaires à disposition">
                </div>
                <div class="mb-3">
                    <label for="id_in_cabinet" class="form-label fw-bold">Stock armoire</label>
                    <input type="number" name="in_cabinet" id="id_in_cabinet" class="form-control" placeholder="Nombre de clés stocké dans l'armoire">
                </div>
                <div class="mb-3">
                    <label for="id_in_safe" class="form-label fw-bold">Stock coffre</label>
                    <input type="number" name="in_safe" id="id_in_safe" class="form-control" placeholder="Nombre de clé sotcké dans le coffre">
                </div>
                <div class="mb-3">
                    <label for="id_comments" class="form-label fw-bold">Commentaires</label>
                    <textarea name="comments" id="id_comments" class="form-control" rows="3" placeholder="Ajoutez des commentaires..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="submit" class="btn btn-primary">Valider les modifications</button>
            </div>
        </form>
    </div>
</div>
</div>
<!-- Modal for Editing a Key -->
<div class="modal fade" id="editKeyModal" tabindex="-1" aria-labelledby="editKeyModalLabel" aria-hidden="true">
<div class="modal-dialog">
    <div class="modal-content">
        <form method="post" action="{% url 'key_update' %}">
            {% csrf_token %}
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="editKeyModalLabel">Modification des informations de la Clé</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <!-- Hidden field to store key ID -->
                <input type="hidden" name="key_id" id="editKeyId">
                
                <!-- Styled Form Fields for Editing -->
                <div class="mb-3 d-flex align-items-center">
                    <!-- Champ Numéro de la clé -->
                    <div style="width: 100px;">
                        <label for="edit_id_number" class="form-label fw-bold">N°</label>
                        <input type="number" name="number" id="edit_id_number" class="form-control" placeholder="000" readonly>
                    </div>
                    <!-- Champ Nom de la clé -->
                    <div class="flex-grow-1 me-3">
                        <label for="edit_id_name" class="form-label fw-bold">Nom de la clé</label>
                        <input type="text" name="name" id="edit_id_name" class="form-control" placeholder="Entrez le nom de la clé">
                    </div>                        
                </div>
                <div class="mb-3">
                    <label for="edit_id_place" class="form-label fw-bold">Emplacement</label>
                    <input type="text" name="place" id="edit_id_place" class="form-control" placeholder="Emplacement de la clé">
                </div>
                <div class="mb-3">
                    <label for="edit_id_total_quantity" class="form-label fw-bold">Nombre total d'exemplaires</label>
                    <input type="number" name="total_quantity" id="edit_id_total_quantity" class="form-control" placeholder="Nombre total d'exemplaires">
                </div>
                <div class="mb-3">
                    <label for="edit_id_in_cabinet" class="form-label fw-bold">Stock armoire</label>
                    <input type="number" name="in_cabinet" id="edit_id_in_cabinet" class="form-control" placeholder="Nombre de clés  stocké dans l'armoire">
                </div>
                <div class="mb-3">
                    <label for="edit_id_in_safe" class="form-label fw-bold">Stock coffre</label>
                    <input type="number" name="in_safe" id="edit_id_in_safe" class="form-control" placeholder="Nombre de clé  sotcké dans le coffre">
                </div>
                <div class="mb-3">
                    <label for="edit_id_comments" class="form-label fw-bold">Commentaires</label>
                    <textarea name="comments" id="edit_id_comments" class="form-control" rows="3" placeholder="Ajoutez des commentaires..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="submit" class="btn btn-primary">Enregistrer les Modifications</button>
            </div>
        </form>
    </div>
</div>
</div>
<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteKeyModal" tabindex="-1" aria-labelledby="deleteKeyModalLabel" aria-hidden="true">
<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="deleteKeyModalLabel">Supprimer la clé</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <!-- Dynamically show the key number -->
            Voulez-vous vraiment supprimer la clé numéro <strong id="keyNumberToDelete"></strong> et tous ses exemplaires ? Cette action ne peut pas être annulée. Cependant le numéro de clé sera de nouveau disponible pour une nouvelle clé.
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <!-- This form will submit the delete action -->
            <form id="deleteKeyForm" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Supprimer</button>
            </form>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Scripts pour la génération de PDF et XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>

<script>
// Add event listener to delete buttons
document.addEventListener('DOMContentLoaded', function () {
    var deleteButtons = document.querySelectorAll('[data-bs-target="#deleteKeyModal"]');
    deleteButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            // Get the key number and delete URL from the clicked button
            var keyNumber = this.getAttribute('data-key-number');
            var deleteUrl = this.getAttribute('data-delete-url');
            // Update the modal content with the key number
            document.getElementById('keyNumberToDelete').innerText = keyNumber;
            // Set the action of the delete form to the delete URL
            document.getElementById('deleteKeyForm').setAttribute('action', deleteUrl);
        });
    });
    
    // Ajout des gestionnaires pour les boutons d'export
    document.getElementById('generatePdfBtn').addEventListener('click', function() {
        // Générer le PDF avec jsPDF
        generatePDF();
    });
    
    document.getElementById('generateXlsxBtn').addEventListener('click', function() {
        // Générer le fichier XLSX avec SheetJS
        generateXLSX();
    });
    
    // Fonction pour générer le PDF
    function generatePDF() {
        // Créer un nouveau document PDF
        const doc = new jsPDF();
        
        // Titre du document
        doc.setFontSize(18);
        doc.text("Liste des clés", 14, 20);
        
        // Informations du document
        const date = new Date().toLocaleDateString('fr-FR');
        doc.setFontSize(11);
        doc.text(`Généré le: ${date}`, 14, 30);
        doc.text(`Total des clés: ${document.querySelector('.ms-auto span:last-child').textContent}`, 14, 35);
        
        // Création du tableau
        const tableData = [];
        const table = document.getElementById('keyTable');
        const rows = table.querySelectorAll('tbody tr');
        
        // Parcourir toutes les lignes du tableau visible
        rows.forEach((row) => {
            if (row.style.display !== 'none') {
                const number = row.cells[0].textContent.trim();
                const name = row.cells[1].textContent.trim();
                const place = row.cells[2].textContent.trim();
                const totalQuantity = row.cells[3].textContent.trim();
                const assignedCount = row.cells[4].textContent.trim();
                const inCabinet = row.cells[5].textContent.trim();
                const inSafe = row.cells[6].textContent.trim();
                tableData.push([number, name, place, totalQuantity, assignedCount, inCabinet, inSafe]);
            }
        });
        
        // Ajouter le tableau au PDF
        doc.autoTable({
            head: [['N°', 'Nom de la clé', 'Emplacement', 'Nb. exemplaires', 'Attribués', 'En armoire', 'En coffre']],
            body: tableData,
            startY: 40,
            styles: { fontSize: 8, cellPadding: 2 },
            headStyles: { fillColor: [58, 159, 135] },
            margin: { top: 40 },
            columnStyles: {
                0: { cellWidth: 15 }, // N°
                1: { cellWidth: 40 }, // Nom
                2: { cellWidth: 30 }, // Emplacement
                3: { cellWidth: 20 }, // Nb exemplaires
                4: { cellWidth: 20 }, // Attribués
                5: { cellWidth: 20 }, // En armoire
                6: { cellWidth: 20 }  // En coffre
            }
        });
        
        // Ajouter le footer
        doc.setFontSize(10);
        doc.text("© Église Évangélique Rencontre Espérance", 14, doc.internal.pageSize.height - 10);
        
        // Enregistrer le PDF
        doc.save("liste_cles.pdf");
    }
    
    // Fonction pour générer le fichier XLSX
    function generateXLSX() {
        // Créer un nouveau workbook
        const wb = XLSX.utils.book_new();
        
        // Préparer les données
        const tableData = [];
        const table = document.getElementById('keyTable');
        const rows = table.querySelectorAll('tbody tr');
        
        // Parcourir toutes les lignes du tableau visible
        rows.forEach((row) => {
            if (row.style.display !== 'none') {
                const number = row.cells[0].textContent.trim();
                const name = row.cells[1].textContent.trim();
                const place = row.cells[2].textContent.trim();
                const totalQuantity = row.cells[3].textContent.trim();
                const assignedCount = row.cells[4].textContent.trim();
                const inCabinet = row.cells[5].textContent.trim();
                const inSafe = row.cells[6].textContent.trim();
                const comments = row.cells[7].textContent.trim();
                
                tableData.push({
                    "N°": number,
                    "Nom de la clé": name,
                    "Emplacement": place,
                    "Nombre d'exemplaires": totalQuantity,
                    "Exemplaires attribués": assignedCount,
                    "En armoire": inCabinet,
                    "En coffre": inSafe,
                    "Commentaires": comments
                });
            }
        });
        
        // Créer une feuille de calcul à partir des données
        const ws = XLSX.utils.json_to_sheet(tableData);
        
        // Ajouter la feuille au workbook
        XLSX.utils.book_append_sheet(wb, ws, "Clés");
        
        // Générer le fichier XLSX et le télécharger
        XLSX.writeFile(wb, "liste_cles.xlsx");
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Obtenir le formulaire de modification
    var editKeyForm = document.getElementById('editKeyForm');
    if (editKeyForm) {
        editKeyForm.addEventListener('submit', function (e) {
            var confirmation = confirm("Êtes-vous sûr de vouloir modifier cette clé ?");
            if (!confirmation) {
                e.preventDefault(); // Empêcher la soumission du formulaire
            }
        });
    }
});
</script>

<!-- JavaScript to Populate Edit Modal -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Get all edit buttons
    var editButtons = document.querySelectorAll('.edit-btn');
    
    // Loop through buttons and add click event listener
    editButtons.forEach(function (button) {
        button.addEventListener('click', function () {
            // Get key data from the button's data attributes
            var keyId = this.getAttribute('data-id');
            var keyNumber = this.getAttribute('data-number');
            var keyName = this.getAttribute('data-name');
            var keyPlace = this.getAttribute('data-place');
            var keyTotal = this.getAttribute('data-total-quantity');
            var keyInCabinet = this.getAttribute('data-in-cabinet');
            var keyInSafe = this.getAttribute('data-in-safe');
            var keyComments = this.getAttribute('data-comments');
            // Populate the modal fields
            document.getElementById('editKeyId').value = keyId;
            document.getElementById('edit_id_number').value = keyNumber;
            document.getElementById('edit_id_name').value = keyName;
            document.getElementById('edit_id_place').value = keyPlace;
            document.getElementById('edit_id_total_quantity').value = keyTotal;
            document.getElementById('edit_id_in_cabinet').value = keyInCabinet;
            document.getElementById('edit_id_in_safe').value = keyInSafe;
            document.getElementById('edit_id_comments').value = keyComments;
        });
    });
});
</script>

<script>
//Fonction de recherche dans le tableau
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');
    const table = document.getElementById('keyTable');
    const rows = table.getElementsByTagName('tr');
    searchInput.addEventListener('keyup', function () {
        const filter = searchInput.value.toLowerCase();
        for (let i = 1; i < rows.length; i++) { // Commence à 1 pour ignorer l'en-tête
            const cells = rows[i].getElementsByTagName('td');
            let match = false;
            for (let cell of cells) {
                if (cell.textContent.toLowerCase().includes(filter)) {
                    match = true;
                    break;
                }
            }
            rows[i].style.display = match ? '' : 'none'; // Affiche ou cache la ligne
        }
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function(popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            trigger: 'focus'  // Permet de fermer le popover en cliquant ailleurs
        });
    });
    // Fermer les autres popovers lorsqu'un nouveau est ouvert
    document.addEventListener("click", function(event) {
        popoverTriggerList.forEach(function(popoverTriggerEl) {
            if (!popoverTriggerEl.contains(event.target)) {
                var popover = bootstrap.Popover.getInstance(popoverTriggerEl);
                if (popover) {
                    popover.hide();
                }
            }
        });
    });
});
</script>
{% endblock %}