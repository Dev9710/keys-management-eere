{% extends 'listings/base.html' %}
{% load static %}

{% block title %}Gestion des équipes{% endblock %}

{% block extra_css %}
<style>

/* Style pour les boutons d'export - Version améliorée */
 .export-buttons {
            display: flex;
            justify-content: center; /* Centre les boutons horizontalement */
            gap: 20px; /* Augmentation de l'espacement entre les boutons */
            margin: 40px 0; /* Plus d'espace en haut et en bas */
            padding-bottom: 40px; /* Espace supplémentaire vers le footer */
        }

/* Optionnel : Ajouter un conteneur wrapper pour un centrage parfait */
.export-section {
    text-align: center;
    margin: 40px 0;
    padding: 20px;
}

/* Style pour les boutons d'export individuels */
.export-buttons .btn {
    min-width: 150px; /* Assure une largeur minimale pour l'alignement */
    padding: 12px 20px;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Style pour les icônes dans les boutons */
.export-buttons .btn i {
    font-size: 16px;
}

/* Responsive : ajustement pour les petits écrans */
@media (max-width: 768px) {
    .export-buttons {
        flex-direction: column;
        gap: 15px;
        margin: 30px auto;
    }
    
    .export-buttons .btn {
        width: 100%;
        max-width: 200px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Titre de la section principale -->
    <h2 class="mb-4">Gestion par équipes</h2>
    
    <div class="d-flex flex-row bd-highlight mb-3 gap-3">
        <!-- Bouton Ajouter une Nouvelle Équipe -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeamModal">
            <i class="fas fa-plus"></i> Ajouter une nouvelle équipe
        </button>
        
        <!-- Champ de Recherche -->
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Rechercher une équipe..." class="form-control w-100">
        </div>
        
        <!-- Total des équipes aligné à droite -->
        <div class="mb-3 ms-auto text-end">
            <span class="fw-bold">Total des équipes :</span>
            <span id="teamsCount">{{ teams_count }}</span>
        </div>
    </div>
    
    <!-- Table pour afficher les équipes -->
    <table class="table table-striped table-hover" id="team_tab">
        <thead class="table-dark">
            <tr>
                <th scope="col" style="width: 60%">Nom</th>
                <th scope="col" style="width: 40%">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for team in teams %}
            <tr>
                <td>{{ team.name }}</td>
                <td>
                    <div class="d-flex gap-2 justify-content-center">
                        <!-- Bouton Modifier -->
                        <button type="button" class="btn btn-warning btn-sm action-btn edit-btn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#editTeamModal" 
                            data-id="{{ team.id }}" 
                            data-name="{{ team.name }}">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                        
                        <!-- Bouton Supprimer -->
                        <button type="button" class="btn btn-danger btn-sm action-btn delete-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteTeamModal"
                            data-delete-url="{% url 'team_delete' team.id %}"
                            data-team-name="{{ team.name }}">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="2" class="text-center">Aucune équipe</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Edit Team Modal -->
    <div class="modal fade" id="editTeamModal" tabindex="-1" aria-labelledby="editTeamModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTeamModalLabel">Modifier l'équipe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editTeamForm" action="{% url 'team_update' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" id="editTeamId" name="id">
                        <div class="mb-3">
                            <label for="editTeamName" class="form-label">Nom</label>
                            <input type="text" class="form-control" id="editTeamName" name="name" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveTeamChanges">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Team Modal -->
    <div class="modal fade" id="addTeamModal" tabindex="-1" aria-labelledby="addTeamModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addTeamForm" method="post" action="{% url 'team_create' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="addTeamModalLabel">Ajouter une équipe</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="addTeamName" class="form-label">Nom</label>
                            <input type="text" class="form-control" id="addTeamName" name="name" required>
                        </div>  
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>                        
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteTeamModal" tabindex="-1" aria-labelledby="deleteTeamModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteTeamModalLabel">Supprimer l'équipe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Voulez-vous vraiment supprimer l'équipe <strong id="TeamNameToDelete"></strong> ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <form id="deleteTeamForm" method="post" action="">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Supprimer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Boutons d'export -->
   <div class="export-buttons" style="display: flex; justify-content: center; gap: 20px; margin: 40px 0; padding-bottom: 40px;">
    <button id="generate-pdf-btn" class="btn btn-danger" style="min-width: 140px;">
        <i class="fas fa-file-pdf"></i> Générer PDF
    </button>
    <button id="generate-xlsx-btn" class="btn btn-success" style="min-width: 140px;">
        <i class="fas fa-file-excel"></i> Générer XLSX
    </button>
</div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Scripts pour la génération de PDF et XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>

<script>
// Fonction pour générer le PDF
function generatePDF() {
    const doc = new jsPDF();
    
    // Titre du document
    doc.setFontSize(18);
    doc.text("Liste des équipes", 14, 20);
    
    // Informations du document
    const date = new Date().toLocaleDateString('fr-FR');
    doc.setFontSize(11);
    doc.text(`Généré le: ${date}`, 14, 30);
    doc.text(`Total des équipes: ${document.getElementById('teamsCount').textContent}`, 14, 35);
    
    // Création du tableau
    const tableData = [];
    const table = document.getElementById('team_tab');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach((row) => {
        if (row.style.display !== 'none' && row.cells[0]) {
            const name = row.cells[0].textContent.trim();
            if (name && name !== 'Aucune équipe') {
                tableData.push([name]);
            }
        }
    });
    
    // Ajouter le tableau au PDF
    if (tableData.length > 0) {
        doc.autoTable({
            head: [['Nom']],
            body: tableData,
            startY: 40,
            styles: { fontSize: 10, cellPadding: 3 },
            headStyles: { fillColor: [58, 159, 135] },
            margin: { top: 40 }
        });
    }
    
    // Footer
    doc.setFontSize(10);
    doc.text("© Église Évangélique Rencontre Espérance", 14, doc.internal.pageSize.height - 10);
    
    // Enregistrer le PDF
    doc.save("liste_equipes.pdf");
}

// Fonction pour générer le fichier XLSX
function generateXLSX() {
    const wb = XLSX.utils.book_new();
    const tableData = [];
    const table = document.getElementById('team_tab');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach((row) => {
        if (row.style.display !== 'none' && row.cells[0]) {
            const name = row.cells[0].textContent.trim();
            if (name && name !== 'Aucune équipe') {
                tableData.push({ "Nom": name });
            }
        }
    });
    
    if (tableData.length > 0) {
        const ws = XLSX.utils.json_to_sheet(tableData);
        XLSX.utils.book_append_sheet(wb, ws, "Équipes");
        XLSX.writeFile(wb, "liste_equipes.xlsx");
    } else {
        alert("Aucune équipe à exporter");
    }
}

// Événement principal au chargement du DOM
document.addEventListener('DOMContentLoaded', function() {
    // Gestion de la modal d'édition avec l'API Bootstrap
    const editModal = document.getElementById('editTeamModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function (event) {
            // Le bouton qui a déclenché la modal
            const button = event.relatedTarget;
            
            // Extraire les données du bouton
            const teamId = button.getAttribute('data-id');
            const teamName = button.getAttribute('data-name');
            
            console.log("Modal d'édition ouverte avec:", { teamId, teamName });
            
            // Mettre à jour les champs de la modal
            if (teamId && teamName) {
                document.getElementById('editTeamId').value = teamId;
                document.getElementById('editTeamName').value = teamName;
            } else {
                console.error("Données manquantes pour l'édition");
            }
        });
    }
    
    // Gestion de la modal de suppression
    const deleteModal = document.getElementById('deleteTeamModal');
    if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const teamName = button.getAttribute('data-team-name');
            const deleteUrl = button.getAttribute('data-delete-url');
            
            document.getElementById('TeamNameToDelete').textContent = teamName;
            document.getElementById('deleteTeamForm').setAttribute('action', deleteUrl);
        });
    }
    
    // Gestion du formulaire de suppression
    const deleteForm = document.getElementById('deleteTeamForm');
    if (deleteForm) {
        deleteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const url = this.getAttribute('action');
            const formData = new FormData(this);
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    throw new Error('Erreur lors de la suppression');
                }
            })
            .catch(error => {
                console.error("Erreur:", error);
                alert("Une erreur s'est produite lors de la suppression");
                bootstrap.Modal.getInstance(deleteModal).hide();
            });
        });
    }
    
    // Gestion de la recherche
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keyup', function () {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll('#team_tab tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });
    }
    
    // Gestion de la sauvegarde des modifications
    const saveButton = document.getElementById('saveTeamChanges');
    if (saveButton) {
        saveButton.addEventListener('click', function() {
            const form = document.getElementById('editTeamForm');
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(editModal).hide();
                    alert(data.message || 'Équipe modifiée avec succès');
                    window.location.reload();
                } else {
                    alert(data.message || 'Une erreur est survenue');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la modification.');
            });
        });
    }
    
    // Gestion de l'ajout d'équipe
    const addTeamForm = document.getElementById('addTeamForm');
    if (addTeamForm) {
        addTeamForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (response.ok) {
                    const modalElement = document.getElementById('addTeamModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                    window.location.reload();
                } else {
                    throw new Error('Erreur lors de l\'ajout');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de l\'ajout de l\'équipe');
            });
        });
    }
    
    // Gestion des boutons d'export
    const pdfBtn = document.getElementById('generatePdfBtn');
    if (pdfBtn) {
        pdfBtn.addEventListener('click', generatePDF);
    }
    
    const xlsxBtn = document.getElementById('generateXlsxBtn');
    if (xlsxBtn) {
        xlsxBtn.addEventListener('click', generateXLSX);
    }
});

// Fonction pour attacher les événements après chargement dynamique
function attachDynamicEvents() {
    // Cette fonction peut être appelée après un chargement AJAX
    // pour réattacher les événements aux nouveaux éléments
}

// Fonction pour charger les équipes dynamiquement (si nécessaire)
function loadTeams(teamId) {
    // Cette fonction reste disponible si vous avez besoin
    // de charger des équipes via AJAX
    console.log('Fonction loadTeams appelée avec teamId:', teamId);
}
</script>
{% endblock %}