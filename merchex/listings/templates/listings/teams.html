{% extends 'listings/base.html' %}
{% load static %}

{% block title %}Gestion des équipes{% endblock %}

{% block extra_css %}
/* Style pour les boutons d'export */
.export-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 30px 0;
}

/* Styles pour les actions */
.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-btn i {
    margin-right: 5px;
}
{% endblock %}

{% block content %}
<div class="container mt-5">
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags %}{{ message.tags }}{% else %}info{% endif %} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <!-- Titre de la section principale -->
    <h2 class="mb-4">Gestion par équipes</h2>
    <div class="d-flex flex-row bd-highlight mb-3 gap-3">
        <!-- Bouton Ajouter une Nouvelle Clé -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeamModal">
            <i class="fas fa-plus"></i> Ajouter une nouvelle équipe
        </button>
        <!-- Champ de Recherche -->
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Rechercher une équipe..."
                class="form-control w-100">
        </div>
        <!-- Total des équipes aligné à droite -->
        <div class="mb-3 ms-auto text-end">
            <span class="fw-bold">Total des équipes :</span>
            <span>{{ teams_count }}</span>
        </div>
    </div>
    <!-- Table pour afficher les éuipes -->
    <table class="table table-striped table-hover" id="team_tab">
        <thead class="table-dark">
            <tr>
                <!-- Définir une largeur fixe pour chaque colonne -->
                <th scope="col" style="width: 40%">Nom</th>
                <th scope="col" style="width: 20%">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for team in teams %}
            <tr>
                <td>{{ team.name }}</td>
                <td>
                    <div class="d-flex gap-2">
                        <!-- Bouton Modifier -->
                        <button type = 'button' class="btn btn-warning btn-sm edit-btn flex-fill action-btn" style="width: 10Opx;"
                             data-bs-toggle="modal" data-bs-target="#editTeamModal" data-id="{{ team.id }}">
                            <i class="fas fa-edit"></i> Modifier
                        </button>
                         <!-- Bouton Supprimer -->
                        <button type="button" class="btn btn-danger btn-sm" style="width: 100px;"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteTeamModal"
                            data-delete-url="{% url 'team_delete' team.id %}"
                            data-team-name="{{ team.name }}">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="2" class="text-center">Aucune équipe</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <!-- Edit Team Modal -->
    <div class="modal fade" id="editTeamModal" tabindex="-1" aria-labelledby="editTeamModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 class="modal-title" id="editTeamModalLabel">Modifier l'équipe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <!-- Modal Body -->
                <div class="modal-body">
                    <form id="editTeamForm" action="{% url 'team_update' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" id="editTeamId" name="id">
                        <div class="mb-3">
                            <label for="editTeamName" class="form-label">Nom</label>
                            <input type="text" class="form-control" id="editTeamName" name="name" required>
                        </div>
                    </form>
                </div>
                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="saveTeamChanges">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add team Modal -->
    <div class="modal fade" id="addTeamModal" tabindex="-1" aria-labelledby="addTeamModalLabel"
    aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addTeamForm" method="post" action="{% url 'team_create' %}">
                    {% csrf_token %}
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="addTeamModalLabel">Ajouter une équipe</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <!-- Modal Body -->
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="addTeamName" class="form-label">Nom</label>
                            <input type="text" class="form-control" id="addTeamName" name="name" required>
                        </div>  
                    </div>
                    <!-- Modal Footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>                        
            </div>
        </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteTeamModal" tabindex="-1" aria-labelledby="deleteTeamModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteTeamModalLabel">Supprimer l'équipe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Message de confirmation avec le nom de l'équipe -->
                    Voulez-vous vraiment supprimer l'équipe <strong id="TeamNameToDelete"></strong> ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <!-- Formulaire explicitement fermé -->
                    <form id="deleteTeamForm" method="post" action="">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">Supprimer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Boutons d'export ajoutés ici -->
    <div class="export-buttons">
        <button type="button" class="btn btn-danger" id="generatePdfBtn">
            <i class="fas fa-file-pdf"></i> Générer PDF
        </button>
        <button type="button" class="btn btn-success" id="generateXlsxBtn">
            <i class="fas fa-file-excel"></i> Générer XLSX
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Scripts pour la génération de PDF et XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>

<script>
   document.addEventListener('DOMContentLoaded', function() {
    // Si des alertes/messages existent déjà, leur appliquer le style Bootstrap
    styleExistingMessages();
    
    // Sélectionner tous les boutons qui ouvrent le modal de suppression
    var deleteButtons = document.querySelectorAll('[data-bs-target="#deleteTeamModal"]');
    var deleteModal = document.getElementById('deleteTeamModal');
    var modalInstance = null;
    
    if (deleteModal) {
        modalInstance = new bootstrap.Modal(deleteModal);
    }
    
    deleteButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            // Récupérer les données de l'équipe
            var teamName = this.getAttribute('data-team-name');
            var deleteUrl = this.getAttribute('data-delete-url');
            
            // Mettre à jour le contenu du modal
            var nameElement = document.getElementById('TeamNameToDelete');
            if (nameElement) nameElement.innerText = teamName;
            
            // Stocker l'URL pour l'utilisation ultérieure
            var deleteForm = document.getElementById('deleteTeamForm');
            if (deleteForm) deleteForm.setAttribute('action', deleteUrl);
        });
    });
    
    // Ajouter un gestionnaire d'événement au formulaire de suppression
    var deleteForm = document.getElementById('deleteTeamForm');
    if (deleteForm) {
        deleteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            var url = this.getAttribute('action');
            var formData = new FormData(this);
            
            // Envoyer la requête AJAX
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                redirect: 'follow'
            })
            .then(response => {
                // Vérifier si c'est une redirection
                if (response.redirected) {
                    // Suivre la redirection mais d'abord extraire le contenu pour voir s'il y a des messages
                    return response.text().then(html => {
                        return { redirectUrl: response.url, html: html };
                    });
                }
                return response.text().then(html => {
                    return { redirectUrl: null, html: html };
                });
            })
            .then(data => {
                // Fermer le modal
                if (modalInstance) modalInstance.hide();
                
                // Extraire les messages du HTML
                var messages = extractMessages(data.html);
                
                if (messages.length > 0) {
                    // Afficher les messages
                    showMessages(messages);
                    
                    // Vérifier si c'est un message d'erreur
                    var hasError = messages.some(msg => msg.type === 'error');
                    if (!hasError && data.redirectUrl) {
                        // Si pas d'erreur et redirection, recharger la page après avoir montré les messages
                        setTimeout(() => {
                            window.location.href = data.redirectUrl;
                        }, 1000);
                    }
                } else if (data.redirectUrl) {
                    // Pas de messages mais redirection
                    window.location.href = data.redirectUrl;
                } else {
                    // Pas de messages, pas de redirection, recharger la page
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error("Erreur:", error);
                if (modalInstance) modalInstance.hide();
                
                // Afficher un message d'erreur générique
                showMessages([{
                    text: "Une erreur s'est produite lors de la suppression",
                    type: "error"
                }]);
            });
        });
    }
    
    // Fonction pour extraire les messages du HTML
    function extractMessages(html) {
        // Créer un DOM temporaire pour analyser le HTML
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        
        var messages = [];
        var messageElements = doc.querySelectorAll('.alert');
        
        messageElements.forEach(el => {
            var type = 'info';
            if (el.classList.contains('alert-danger')) type = 'error';
            if (el.classList.contains('alert-success')) type = 'success';
            if (el.classList.contains('alert-warning')) type = 'warning';
            
            messages.push({
                text: el.textContent.trim(),
                type: type
            });
        });
        
        return messages;
    }
    
    // Fonction pour afficher les messages
    function showMessages(messages) {
        // Créer un conteneur pour les messages s'il n'existe pas
        var container = document.querySelector('.messages-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'messages-container';
            document.querySelector('.container').prepend(container);
        }
        
        // Vider le conteneur
        container.innerHTML = '';
        
        // Ajouter chaque message
        messages.forEach(msg => {
            var alertClass = 'info';
            if (msg.type === 'error') alertClass = 'danger';
            if (msg.type === 'success') alertClass = 'success';
            if (msg.type === 'warning') alertClass = 'warning';
            
            var alert = document.createElement('div');
            alert.className = `alert alert-${alertClass} alert-dismissible fade show`;
            alert.innerHTML = `
                ${msg.text}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            container.appendChild(alert);
        });
    }
    
    // Fonction pour appliquer le style Bootstrap aux messages existants
    function styleExistingMessages() {
        var djangoMessages = document.querySelectorAll('.messages .message');
        djangoMessages.forEach(msg => {
            var type = 'info';
            if (msg.classList.contains('error')) type = 'danger';
            if (msg.classList.contains('success')) type = 'success';
            if (msg.classList.contains('warning')) type = 'warning';
            
            msg.classList.add(`alert`, `alert-${type}`, 'alert-dismissible', 'fade', 'show');
            
            // Ajouter un bouton de fermeture s'il n'existe pas
            if (!msg.querySelector('.btn-close')) {
                var closeBtn = document.createElement('button');
                closeBtn.type = 'button';
                closeBtn.className = 'btn-close';
                closeBtn.setAttribute('data-bs-dismiss', 'alert');
                closeBtn.setAttribute('aria-label', 'Close');
                msg.appendChild(closeBtn);
            }
        });
    }
    
    // Ajout des gestionnaires pour les boutons d'export
    document.getElementById('generatePdfBtn').addEventListener('click', function() {
        // Générer le PDF avec jsPDF
        generatePDF();
    });
    
    document.getElementById('generateXlsxBtn').addEventListener('click', function() {
        // Générer le fichier XLSX avec SheetJS
        generateXLSX();
    });
    
    // Fonction pour générer le PDF
    function generatePDF() {
        // Créer un nouveau document PDF
        const doc = new jsPDF();
        
        // Titre du document
        doc.setFontSize(18);
        doc.text("Liste des équipes", 14, 20);
        
        // Informations du document
        const date = new Date().toLocaleDateString('fr-FR');
        doc.setFontSize(11);
        doc.text(`Généré le: ${date}`, 14, 30);
        doc.text(`Total des équipes: ${document.querySelector('.ms-auto span:last-child').textContent}`, 14, 35);
        
        // Création du tableau
        const tableData = [];
        const table = document.getElementById('team_tab');
        const rows = table.querySelectorAll('tbody tr');
        
        // Parcourir toutes les lignes du tableau visible
        rows.forEach((row) => {
            if (row.style.display !== 'none') {
                const name = row.cells[0].textContent.trim();
                tableData.push([name]);
            }
        });
        
        // Ajouter le tableau au PDF
        doc.autoTable({
            head: [['Nom']],
            body: tableData,
            startY: 40,
            styles: { fontSize: 10, cellPadding: 3 },
            headStyles: { fillColor: [58, 159, 135] },
            margin: { top: 40 }
        });
        
        // Ajouter le footer
        doc.setFontSize(10);
        doc.text("© Église Évangélique Rencontre Espérance", 14, doc.internal.pageSize.height - 10);
        
        // Enregistrer le PDF
        doc.save("liste_equipes.pdf");
    }
    
    // Fonction pour générer le fichier XLSX
    function generateXLSX() {
        // Créer un nouveau workbook
        const wb = XLSX.utils.book_new();
        
        // Préparer les données
        const tableData = [];
        const table = document.getElementById('team_tab');
        const rows = table.querySelectorAll('tbody tr');
        
        // Parcourir toutes les lignes du tableau visible
        rows.forEach((row) => {
            if (row.style.display !== 'none') {
                const name = row.cells[0].textContent.trim();
                tableData.push({ "Nom": name });
            }
        });
        
        // Créer une feuille de calcul à partir des données
        const ws = XLSX.utils.json_to_sheet(tableData);
        
        // Ajouter la feuille au workbook
        XLSX.utils.book_append_sheet(wb, ws, "Équipes");
        
        // Générer le fichier XLSX et le télécharger
        XLSX.writeFile(wb, "liste_equipes.xlsx");
    }
});
</script>

<script>
    const TeamTableBody = document.querySelector('#team_tab tbody'); // Corps du tableau des éuipes
    function loadUserbyTeam(teamId) {
            const baseUrl = teamDropdown.getAttribute('data-url'); // URL de base
            const url = `${baseUrl}?id=${teamId}`; // Construire l'URL complète
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    teamTableBody.innerHTML = ''; // Vider le tableau
                    if (data.teams.length > 0) {
                        data.teams.forEach(team => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
            <td>${team.name}</td>
               <td>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-warning btn-sm edit-btn" 
                        data-bs-toggle="modal" 
                        data-bs-target="#editTeamModal" 
                        data-id="${team.id}" 
                        data-name="${team.name}" 
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                    <form method="post" action="/team_delete/${team.id}/">
                    <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" 
data-bs-target="#deleteTeamModal" 
data-delete-url="/team_delete/${team.id}/" 
data-user-name="${team.name}">
<i class="fas fa-trash"></i> Supprimer
</button>
                </form>
                </div>
            </td>
        `;
                            teamTableBody.appendChild(row);
                        });
                    } else {
                        // Si aucune équipe n'est trouvé
                        const row = document.createElement('tr');
                        row.innerHTML = `<td colspan="6" class="text-center">Aucun équipe trouvé.</td>`;
                        teamTableBody.appendChild(row);
                    }
                    // Réattacher les événements aux boutons dynamiques
                    attachEditButtonEvents();
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des éuipes :', error);
                });
        }
    document.addEventListener('DOMContentLoaded', function () {
    });
</script>

<script>
    //Fonction de recherche dans le tableau
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const table = document.getElementById('team_tab');
        const rows = table.getElementsByTagName('tr');
    
        searchInput.addEventListener('keyup', function () {
            const filter = searchInput.value.toLowerCase();
    
            for (let i = 1; i < rows.length; i++) { // Commence à 1 pour ignorer l'en-tête
                const cells = rows[i].getElementsByTagName('td');
                let match = false;
    
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(filter)) {
                        match = true;
                        break;
                    }
                }
    
                rows[i].style.display = match ? '' : 'none'; // Affiche ou cache la ligne
            }
        });
    });
    
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        // Pour sauvegarder les modifications
        document.getElementById('saveTeamChanges').addEventListener('click', function() {
            const form = document.getElementById('editTeamForm');
            const formData = new FormData(form);
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editTeamModal'));
                    modal.hide();
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la modification.');
            });
        });
    });
    document.addEventListener('DOMContentLoaded', function () {
        attachEditButtonEvents(); // Attacher les événements aux boutons existants
    });
</script>

<script>
      // Pour éditer une équipe
function editTeam(id, name) {
    document.getElementById('editTeamId').value = id;
    document.getElementById('editTeamName').value = name;
    
    const modal = new bootstrap.Modal(document.getElementById('editTeamModal'));
    modal.show();
}
</script>

<script>
    function attachEditButtonEvents() {
        console.log("Attachement des événements...");
        document.querySelectorAll('.edit-btn').forEach(button => {
            //console.log("Bouton détecté :", button);
            button.addEventListener('click', function () {
                const teamName = this.getAttribute('data-name');
                // Vérifiez si l'ID de l'équipe est défini
                if (!userTeam || userTeam === 'undefined') {
                    console.error("L'ID de l'équipe est manquant ou incorrect.");
                    return; // Arrêter l'exécution si l'ID est invalide
                }
                console.log("Données équipe :", { teamName });
                // Remplir les champs de la modal
                document.getElementById('editTeamName').value = teamName;          
            });
        });
    }
</script>

<script>
    //script pour la validation du formation d'ajout équi^pe
    document.addEventListener('DOMContentLoaded', function () {
        const addTeamForm = document.getElementById('addTeamForm');
        addTeamForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
                .then(response => response.text())
                .then(data => {
                    // Fermer la modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addTeamModal'));
                    modal.hide();
                    // Recharger la page pour voir le nouvelle équipe
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Une erreur est survenue lors de l\'ajout de l\'équipe');
                });
        });
    });
</script>
{% endblock %}